# F4: Tribes -- Systems Design

**Feature**: Tribes
**Context**: See [overview.md](./overview.md) for architecture overview, service boundaries, and deployment.
**Source**: Extracted from [SYSTEMS_DESIGN.md](../SYSTEMS_DESIGN.md)

---

## Table of Contents

1. [Database Tables](#database-tables)
2. [Tribe State Machine](#tribe-state-machine)
3. [Data Flow: Tribe Formation and Member Approval](#data-flow-tribe-formation-and-member-approval)
4. [Indexing Strategy](#indexing-strategy)
5. [GraphQL Schema](#graphql-schema)
6. [Authorization Rules](#authorization-rules)
7. [Tribe Search](#tribe-search)
8. [N+1 Prevention](#n1-prevention)
9. [Feed Events Generated by Tribe Actions](#feed-events-generated-by-tribe-actions)

---

## Database Tables

### `tribes`

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | CHAR(26) | PK | ULID |
| name | VARCHAR(100) | NOT NULL | |
| mission | TEXT | NULLABLE | |
| owner_id | CHAR(26) | FK -> users(id) ON DELETE CASCADE, NOT NULL | |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'open' | 'open', 'active', 'alumni' |
| max_members | INTEGER | DEFAULT 8, CHECK (max_members >= 1) | |
| search_vector | TSVECTOR | NULLABLE | GIN-indexed for full-text search |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | |

### `tribe_members`

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| tribe_id | CHAR(26) | PK (composite), FK -> tribes(id) ON DELETE CASCADE | |
| user_id | CHAR(26) | PK (composite), FK -> users(id) ON DELETE CASCADE | |
| role | ENUM | NOT NULL, DEFAULT 'member' | 'owner', 'member' — membership role |
| status | ENUM | NOT NULL, DEFAULT 'pending' | 'pending', 'active', 'rejected', 'left', 'removed' |
| requested_role_id | CHAR(26) | FK -> tribe_open_roles(id), NULLABLE | Which open role they applied for |
| joined_at | TIMESTAMPTZ | NULLABLE | Set when status becomes 'active' |
| requested_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | |

**Primary key**: composite (tribe_id, user_id) — a user can only be a member once per tribe.

### `tribe_open_roles`

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | CHAR(26) | PK | ULID |
| tribe_id | CHAR(26) | FK -> tribes(id) ON DELETE CASCADE, NOT NULL | |
| title | VARCHAR(100) | NOT NULL | "Backend Engineer" |
| skills_needed | JSONB | DEFAULT '[]' | ["Python", "PostgreSQL"] |
| filled | BOOLEAN | NOT NULL, DEFAULT false | |
| filled_by | CHAR(26) | FK -> users(id), NULLABLE | Set when role is filled |

---

## Tribe State Machine

Tribes transition through three states:

```
    +-------+          +--------+          +---------+
    | open  | -------> | active | -------> | alumni  |
    +-------+          +--------+          +---------+
         ^                  |                   |
         |                  |                   |
         +------------------+-------------------+
          (owner reopens)
```

**State definitions**:

| Status | Description | Transitions |
|--------|-------------|-------------|
| `open` | Tribe is actively recruiting members. Open roles are visible in discovery. Applicants can request to join. | -> `active` (owner sets via updateTribe) |
| `active` | Tribe is full or recruitment is closed. Members are collaborating. No new join requests accepted. | -> `open` (owner reopens recruitment), -> `alumni` (owner archives tribe or project completes) |
| `alumni` | Tribe has completed its mission or been archived. Members retain the association on their profiles as history. Read-only. | -> `open` (owner reopens recruitment) |

**Constraints enforced during transitions**:
- `open` -> `active`: At least 1 member must be in `active` status (the owner)
- `active` -> `open`: No constraints
- Any -> `alumni`: Only the tribe owner can archive
- When tribe status is `open`, `requestToJoin` mutation is allowed
- When tribe status is `active` or `alumni`, `requestToJoin` mutation is rejected

**Member status within a tribe**:

| Member Status | Description |
|---------------|-------------|
| `pending` | User has requested to join; awaiting owner approval |
| `active` | User is an active member of the tribe |
| `rejected` | Join request was declined by the owner |
| `left` | User voluntarily left the tribe |
| `removed` | User was removed by the tribe owner |

---

## Data Flow: Tribe Formation and Member Approval

```
Owner                          FastAPI                  PostgreSQL            Applicant
   |                              |                        |                      |
   | 1. createTribe mutation      |                        |                      |
   |    {name, mission, maxMembers}|                       |                      |
   |---------------------------->|                        |                      |
   |                              | 2. BEGIN TRANSACTION   |                      |
   |                              |---INSERT tribe-------->|                      |
   |                              |---INSERT tribe_member->|                      |
   |                              |    (owner, 'active')   |                      |
   |                              |   (roles added separately via addOpenRole)     |
   |                              |---INSERT feed_event--->|                      |
   |                              |    (tribe_created)     |                      |
   |                              |    COMMIT              |                      |
   |<--tribe created--------------|                        |                      |
   |                              |                        |                      |
   |                              |  ... applicant browses open tribes ...        |
   |                              |                        |                      |
   |                              |<----requestToJoin(tribe_id, role_id)------------|
   |                              |                        |                      |
   |                              | 3. Verify tribe is 'open',                   |
   |                              |    not at max_members,                        |
   |                              |    role exists and not filled                  |
   |                              |---INSERT tribe_member->|                      |
   |                              |    (status: 'pending', |                      |
   |                              |     requested_role_id) |                      |
   |                              |                        |                      |
   |                              |<--request submitted----|                      |
   |                              |                        |                      |
   |  ... owner reviews ...       |                        |                      |
   |                              |                        |                      |
   | 4. approveMember mutation    |                        |                      |
   |    {tribe_id, user_id}       |                        |                      |
   |---------------------------->|                        |                      |
   |                              | 5. Verify owner        |                      |
   |                              |---UPDATE tribe_member->|                      |
   |                              |    status='active'     |                      |
   |                              |    joined_at=NOW()     |                      |
   |                              |---UPDATE open_role---->|                      |
   |                              |    filled=true,        |                      |
   |                              |    filled_by=user_id   |                      |
   |                              |---INSERT feed_event--->|                      |
   |                              |  (member_joined_tribe) |                      |
   |                              |                        |                      |
   |<--member approved------------|                        |                      |
```

---

## Indexing Strategy

```sql
-- Tribe queries
CREATE INDEX ix_tribes_owner_id ON tribes (owner_id);
CREATE INDEX ix_tribes_status ON tribes (status);
CREATE INDEX ix_tribes_search_vector ON tribes USING gin (search_vector);
CREATE INDEX ix_tribe_members_user ON tribe_members (user_id);
-- tribe_members(tribe_id) covered by composite PK
CREATE INDEX ix_tribe_open_roles_tribe_id ON tribe_open_roles (tribe_id);
```

---

## GraphQL Schema

```
src/backend/app/graphql/
  types/
    tribe.py           # TribeType, TribeMemberType, OpenRoleType
  queries/
    health.py          # tribe(id), tribes(limit, offset, status), searchTribes(query, limit, offset) — co-located with other queries
  mutations/
    tribes.py          # TribeMutations class: createTribe, updateTribe, addOpenRole, removeOpenRole,
                       # requestToJoin, approveMember, rejectMember, removeMember, leaveTribe
```

---

## Authorization Rules

| Resource | Action | Who Can Do It |
|----------|--------|---------------|
| **Tribe** | View | Anyone (public) |
| **Tribe** | Create | Any authenticated user |
| **Tribe** | Edit | Owner only |
| **Tribe** | Add open role | Owner only |
| **Tribe** | Remove open role | Owner only |
| **Tribe** | Request to join | Any authenticated user (not already a member), tribe must be 'open' |
| **Tribe** | Approve member | Owner only |
| **Tribe** | Reject member | Owner only |
| **Tribe** | Remove member | Owner only |
| **Tribe** | Leave tribe | Active member (not owner) |

Implementation: Authorization checks live in the **service layer**, not in resolvers.

---

## Tribe Search

**Approach:** Query-time joins across existing TSVECTOR indexes. Single search bar, no filter dropdowns.

**Data flow:**
```
User types "Python"
  |
  v
searchTribes(query: "Python", limit: 20, offset: 0)
  |
  v
Service layer builds JOIN query across:
  tribes.search_vector         ← name, mission
  tribe_open_roles             ← title, skills_needed
  users (via tribe_members)    ← display_name, timezone
  |
  v
Results deduped by tribe ID, ranked by ts_rank
  |
  v
Return list of TribeType
```

**Note:** Project search deferred until the Associated Project relationship is implemented (see product spec TBD).

**Why query-time joins:** No triggers, no denormalization, always fresh. Acceptable performance at current scale since all joined tables have GIN indexes on their search vectors.

---

## N+1 Prevention

Tribe queries use SQLAlchemy `selectinload` for eager loading of relationships (`owner`, `members`, `open_roles`), not DataLoaders. This batches SQL queries when rendering a list of tribes with their members.

```python
stmt = select(Tribe).options(
    selectinload(Tribe.owner),
    selectinload(Tribe.members),
    selectinload(Tribe.open_roles),
)
```

---

## Feed Events Generated by Tribe Actions

| Event Type | Trigger | Metadata Example |
|------------|---------|-----------------|
| `tribe_created` | Tribe created | `{"tribe_name": "Fintech Builders", "open_roles": ["React Native Developer", "Growth Marketer"], "member_count": 1}` |
| `member_joined_tribe` | Member approved and status set to 'active' | `{"tribe_name": "Fintech Builders", "member_name": "Jane Doe", "role": "React Native Developer"}` |
