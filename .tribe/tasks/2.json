{
  "id": "2",
  "title": "Add BuildActivity model and tribe_id to Project",
  "description": "Create the BuildActivity model and add tribe_id FK to the Project model. Then generate an Alembic migration.\n\n**1. Add BuildActivitySource enum** to `src/backend/app/models/enums.py`:\n```python\nclass BuildActivitySource(StrEnum):\n    ANTHROPIC = \"anthropic\"\n    OPENAI = \"openai\"\n    GOOGLE = \"google\"\n    MANUAL = \"manual\"\n    OTHER = \"other\"\n```\n\n**2. Create** `src/backend/app/models/build_activity.py`:\n```python\nclass BuildActivity(Base, ULIDMixin, TimestampMixin):\n    __tablename__ = \"build_activities\"\n\n    user_id: Mapped[str] = mapped_column(\n        String(26), ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False\n    )\n    project_id: Mapped[str | None] = mapped_column(\n        String(26), ForeignKey(\"projects.id\", ondelete=\"SET NULL\"), nullable=True\n    )\n    activity_date: Mapped[date] = mapped_column(Date, nullable=False)\n    tokens_burned: Mapped[int] = mapped_column(Integer, nullable=False)\n    source: Mapped[str] = mapped_column(\n        SQLEnum(BuildActivitySource, values_callable=lambda x: [e.value for e in x]),\n        nullable=False,\n    )\n    metadata_: Mapped[dict | None] = mapped_column(\"metadata\", JSONB, default=dict)\n\n    user: Mapped[\"User\"] = relationship(back_populates=\"build_activities\")\n    project: Mapped[\"Project | None\"] = relationship()\n\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"project_id\", \"activity_date\", \"source\",\n                         name=\"uq_build_activity_per_day\"),\n        Index(\"ix_build_activities_user_date\", \"user_id\", \"activity_date\"),\n        Index(\"ix_build_activities_project\", \"project_id\",\n              postgresql_where=text(\"project_id IS NOT NULL\")),\n    )\n```\n\n**IMPORTANT**: The `values_callable=lambda x: [e.value for e in x]` on SQLEnum is REQUIRED \u2014 without it PostgreSQL enum types use uppercase names instead of lowercase values.\n\n**3. Add `tribe_id` to Project model** in `src/backend/app/models/project.py`:\n```python\ntribe_id: Mapped[str | None] = mapped_column(\n    String(26), ForeignKey(\"tribes.id\", ondelete=\"SET NULL\"), nullable=True\n)\ntribe: Mapped[\"Tribe | None\"] = relationship(back_populates=\"projects\")\n```\n\n**4. Add `projects` relationship to Tribe** in `src/backend/app/models/tribe.py`:\n```python\nprojects: Mapped[list[\"Project\"]] = relationship(back_populates=\"tribe\")\n```\n\n**5. Add `build_activities` relationship to User** in `src/backend/app/models/user.py`:\n```python\nbuild_activities: Mapped[list[\"BuildActivity\"]] = relationship(back_populates=\"user\", cascade=\"all, delete-orphan\")\n```\n\n**6. Export** `BuildActivity` and `BuildActivitySource` from `src/backend/app/models/__init__.py`.\n\n**7. Generate Alembic migration**:\n```bash\ncd src/backend && alembic revision --autogenerate -m \"add_build_activities_and_tribe_id\"\n```\nReview the generated migration \u2014 ensure enum values are lowercase strings, not uppercase names. The migration should create the `build_activities` table and add `tribe_id` column to `projects`.\n\n**Do NOT set `index=True` on any column that also has an explicit `Index()` in `__table_args__`** \u2014 this creates duplicate indexes.",
  "acceptance_criteria": "- `src/backend/app/models/build_activity.py` exists with BuildActivity model\n- BuildActivitySource enum added to enums.py with 5 values (all lowercase)\n- Project model has tribe_id FK to tribes.id with SET NULL on delete\n- Tribe model has `projects` relationship back_populates=\"tribe\"\n- User model has `build_activities` relationship\n- BuildActivity and BuildActivitySource exported from models/__init__.py\n- Alembic migration file exists in migrations/versions/\n- Migration creates build_activities table with correct columns and constraints\n- Migration adds tribe_id column to projects table\n- `cd src/backend && ruff check .` passes\n- No duplicate indexes (no column has both index=True and explicit Index())",
  "depends_on": [],
  "status": "done",
  "branch": "tribe/task-2-build-activity-model-tribe-id",
  "agent_model": "sonnet",
  "created_at": "2026-02-17T09:00:00Z",
  "started_at": null,
  "completed_at": null,
  "agent_pid": null,
  "error": "",
  "review_feedback": null,
  "files_touched": []
}