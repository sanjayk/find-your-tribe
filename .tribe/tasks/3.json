{
  "id": "3",
  "title": "Burn service and GraphQL burn layer",
  "description": "Create the burn service for BuildActivity CRUD and aggregation, plus the GraphQL types/queries/mutations to expose burn data.\n\n**Part A: Burn Service**\n\nCreate `src/backend/app/services/__init__.py` (empty) and `src/backend/app/services/burn_service.py`:\n\n1. `log_session(session, user_id, tokens_burned, source, project_id=None, activity_date=None)` — Creates or updates (upserts) a BuildActivity row for the given day. If a row already exists for the same (user_id, project_id, activity_date, source), add to the existing tokens_burned. Uses `activity_date or date.today()`.\n\n2. `get_summary(session, user_id, weeks=52)` — Returns burn summary data:\n   - Query BuildActivity for user_id where activity_date >= today - weeks*7\n   - Group by activity_date, sum tokens_burned\n   - Calculate: days_active, total_tokens, active_weeks (weeks with any activity), total_weeks, weekly_streak (consecutive active weeks from most recent), daily_activity list\n   - Return as a dict matching BurnSummaryType fields\n\n3. `get_receipt(session, user_id, project_id)` — Returns per-project burn receipt:\n   - Query BuildActivity for user_id + project_id\n   - Calculate: total_tokens, duration_weeks (first to last activity), peak_week_tokens, daily_activity list\n   - Return as a dict matching BurnReceiptType fields\n\nAll functions are `async` and accept `AsyncSession` as first parameter.\n\n**Part B: GraphQL Types**\n\nCreate `src/backend/app/graphql/types/burn.py`:\n\n```python\n@strawberry.type\nclass BurnDayType:\n    date: datetime.date\n    tokens: int\n\n@strawberry.type\nclass BurnReceiptType:\n    project_id: strawberry.ID\n    total_tokens: int\n    duration_weeks: int\n    peak_week_tokens: int\n    daily_activity: list[BurnDayType]\n\n@strawberry.type\nclass BurnSummaryType:\n    days_active: int\n    total_tokens: int\n    active_weeks: int\n    total_weeks: int\n    weekly_streak: int\n    daily_activity: list[BurnDayType]\n```\n\nExport from `src/backend/app/graphql/types/__init__.py`.\n\n**Part C: GraphQL Queries**\n\nAdd to the existing Query class in `src/backend/app/graphql/queries/health.py`:\n\n```python\n@strawberry.field\nasync def burn_summary(\n    self, info: Info[Context, None], user_id: strawberry.ID, weeks: int = 52\n) -> BurnSummaryType | None:\n    session = info.context.session\n    return await burn_service.get_summary(session, str(user_id), weeks=weeks)\n\n@strawberry.field\nasync def burn_receipt(\n    self, info: Info[Context, None], user_id: strawberry.ID, project_id: strawberry.ID\n) -> BurnReceiptType | None:\n    session = info.context.session\n    return await burn_service.get_receipt(session, str(user_id), str(project_id))\n```\n\n**Part D: GraphQL Mutation**\n\nAdd to `src/backend/app/graphql/mutations/__init__.py`:\n\n```python\n@strawberry.mutation\nasync def log_build_session(\n    self,\n    info: Info[Context, None],\n    tokens_burned: int,\n    source: str,\n    project_id: strawberry.ID | None = None,\n    activity_date: datetime.date | None = None,\n) -> BurnSummaryType:\n    session = info.context.session\n    await burn_service.log_session(\n        session, user_id=\"placeholder\",  # TODO: from auth context\n        tokens_burned=tokens_burned, source=source,\n        project_id=str(project_id) if project_id else None,\n        activity_date=activity_date,\n    )\n    await session.commit()\n    return await burn_service.get_summary(session, \"placeholder\")\n```\n\nNote: Auth is not built yet, so use a placeholder user_id with a TODO comment.",
  "acceptance_criteria": "- `src/backend/app/services/burn_service.py` exists with log_session, get_summary, get_receipt\n- `src/backend/app/graphql/types/burn.py` exists with BurnDayType, BurnReceiptType, BurnSummaryType\n- Burn types exported from graphql/types/__init__.py\n- burn_summary and burn_receipt queries added to Query class\n- log_build_session mutation added to Mutation class\n- get_summary correctly calculates days_active, total_tokens, active_weeks, weekly_streak\n- get_receipt correctly calculates duration_weeks and peak_week_tokens\n- `cd src/backend && ruff check .` passes\n- `cd src/backend && python -m pytest` passes (if tests exist)",
  "depends_on": ["2"],
  "status": "pending",
  "branch": "tribe/task-3-burn-service-graphql-layer",
  "agent_model": "sonnet",
  "created_at": "2026-02-17T09:00:00Z",
  "started_at": null,
  "completed_at": null,
  "agent_pid": null,
  "error": null,
  "review_feedback": null,
  "files_touched": []
}
